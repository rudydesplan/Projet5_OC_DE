# üè• Healthcare CSV ‚Üí MongoDB Loader (v2)

Ce projet fournit un pipeline **robuste, test√©, dockeris√© et extensible** pour charger des donn√©es patients depuis un CSV vers MongoDB.

Il suit un **d√©veloppement par branches** avec revue des fonctionnalit√©s avant merge.

- **main** ‚Äî branche de production
- **dev** ‚Äî branche de d√©veloppement continu
- **remote-testing** ‚Äî branche d√©di√©e aux tests d'int√©gration √† distance

üìÖ **Historique de commits actif sur ‚â• 2 semaines**  
üí¨ Visualisez le graphe r√©seau complet ici :  
[https://github.com/rudydesplan/Projet5_OC_DE/network](https://github.com/rudydesplan/Projet5_OC_DE/network)

![GitHub Network Graph](https://github.com/rudydesplan/Projet5_OC_DE/raw/main/docs/github-network.png)

---

> üí° *L'image ci-dessus est g√©n√©r√©e depuis l'onglet **Insights ‚Üí Network** de GitHub.*  
> Elle prouve l‚Äôusage actif de branches, de merges et de commits continus.
---

## üöÄ Fonctionnalit√©s cl√©s

| ‚úî  | D√©tail |
|----|--------|
|üóÑÔ∏è|**Sch√©mas JSON** stricts sur 4 collections (Patients, Admissions, MedicalRecords, Billing)|
|‚ö°|Insertion **batch** via `bulk_write` (mode *ordonn√©* ‚áí arr√™t sur premi√®re erreur, reprise automatique)|
|üîê|Initialisation automatique et idempotente des r√¥les et utilisateurs (loader, analyst)|
|üîç|**Index** compos√©s et simples cr√©√©s automatiquement|
|üßΩ|Nettoyage & validation **vectoris√©s** (`pandas`) avant insertion|
|üìù|**Logs** d√©taill√©s (rotation 500 KB / 5 jours) via `loguru`|
|üß™|Tests **unitaires** isol√©s (`pytest` + `mongomock`)|
|üê≥|D√©ploiement **Docker / Docker-Compose** (Mongo + App)|
|üõ†|Commandes **Makefile** ‚Äúbuild / up / down / test‚Äù|
|üîê|Section S√©curit√© : **auth Mongo, r√¥les, commandes de cr√©ation, connexion**|

---

## üóÇ Arborescence du projet

```bash
Root/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ healthcare_dataset.csv
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Healthcare_Dataset_Dictionary.csv
‚îÇ   ‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_healthcare_loader.py
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ healthcare_mongo_loader_optimized.py
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ docs/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ Makefile
‚îî‚îÄ‚îÄ README.md
```

---

## üß© Sch√©mas JSON appliqu√©s / mis √† jour  

| Collection         | Champs (cl√©s)                                                       | Contraintes principales*                                                                                                      |
|--------------------|---------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------|
| **Patients**       | `Name`, `Age`, `Gender`, `Blood Type`, `Medical Condition`          | `Name : string` ¬∑ `Age : long ‚àà [0-125]` ¬∑ `Gender ‚àà {Male, Female}` ¬∑ `Blood Type ‚àà {A¬±, B¬±, O¬±, AB¬±}` ¬∑ `Medical Condition ‚àà {Cancer, Obesity, Diabetes, Asthma, Hypertension, Arthritis}` |
| **Admissions**     | `patient_id`, `Date of Admission`, `Admission Type`, `Room Number`, `Discharge Date` | `patient_id : objectId` ¬∑ `Date of Admission : date` ¬∑ `Admission Type ‚àà {Urgent, Emergency, Elective, null}` ¬∑ `Room Number : long ‚â• 1 | null` ¬∑ `Discharge Date : date | null` |
| **MedicalRecords** | `patient_id`, `Doctor`, `Hospital`, `Medication`, `Test Results`    | `patient_id : objectId` ¬∑ `Doctor : string` ¬∑ `Hospital : string` ¬∑ `Medication : string | null` ¬∑ `Test Results ‚àà {Normal, Abnormal, Inconclusive, null}` |
| **Billing**        | `patient_id`, `Billing Amount`, `Insurance Provider`                | `patient_id : objectId` ¬∑ `Billing Amount : double ‚â• 0 | null` ¬∑ `Insurance Provider : string | null`                                                              |

\*Table simplifi√©e ; les d√©finitions compl√®tes (titres, types BSON, `required`, bornes, etc.) se trouvent dans `healthcare_mongo_loader_optimized.py`.

> Les sch√©mas sont appliqu√©s via `collMod` (si la collection existe) ou lors de la cr√©ation (`validationLevel: "strict"`, `validationAction: "error"`).

---

üìä **Diagramme entit√©-relation des collections**

![MongoDB Schema Diagram](https://github.com/rudydesplan/Projet5_OC_DE/raw/main/docs/diagram.png)

*Ce diagramme montre les relations entre la collection centrale `Patients` et les collections secondaires li√©es (`Admissions`, `MedicalRecords`, `Billing`).*

## ‚ö° Index cr√©√©s automatiquement

| Collection     | Index                                         | Pourquoi un ¬´ 1 ¬ª ?*                                  |
| -------------- | --------------------------------------------- | ----------------------------------------------------- |
| Patients       | `[(Name,1)‚Ä¶(Medical Condition,1)]` **unique** | `1` = *ordre croissant* (cl√© d‚Äôindex Mongo classique) |
| Admissions     | `[(patient_id,1),(Date of Admission,1)]`      | Acc√®s rapide par patient + p√©riode                    |
| MedicalRecords | `[(patient_id,1),(Doctor,1)]`                 | Requ√™tes patient-m√©decin                              |
| Billing        | `[(patient_id,1),(Billing Amount,1)]`         | Analyse facturation par patient                       |

\*Dans MongoDB un index se d√©finit par (cl√©, direction) ; `1` = ASC, `-1` = DESC.

---

## üß≠ Flux de traitement

1. Connexion admin initiale : Le script se connecte d'abord √† Mongo en tant qu'utilisateur root via une URI d√©di√©e (--admin_mongo_uri).

2. Initialisation des R√¥les & Utilisateurs : Il ex√©cute une fonction idempotente (initialize_mongodb_users_and_roles) qui cr√©e les r√¥les (loaderRole, analystRole) et les utilisateurs (loader, analyst) s'ils n'existent pas.

3. Connexion loader : Le script se d√©connecte puis se reconnecte avec l'utilisateur loader, qui a des privil√®ges limit√©s, respectant ainsi le principe du moindre privil√®ge.

4. Application des Sch√©mas & Index : Cr√©ation ou mise √† jour des validateurs de sch√©ma (collMod) et des index pour les 4 collections.

5. Lecture CSV par Chunks : Lecture du fichier CSV par lots (taille par d√©faut : 5 000).

6. Nettoyage & Validation : Conversions de types, nettoyage de texte et validation vectoris√©e des donn√©es patients via pandas.

7. Bulk-Upsert/Insert :

	- Les Patients sont ins√©r√©s/mis √† jour via UpdateOne en mode upsert.

	- Les documents li√©s (Admissions, MedicalRecords, Billing) sont ins√©r√©s via InsertOne.

	- Toutes les op√©rations sont ordonn√©es : en cas d'erreur de validation, le lot est interrompu et le script tente d'ins√©rer les documents restants un par un.

8. Logs D√©taill√©s : Journalisation des succ√®s et des erreurs pour chaque lot.

---

## ‚úÖ Tests automatis√©s (`pytest + mongomock`)

```bash
make test
```

Le jeu de tests v√©rifie :

| Test                              | Description                                                                                             |
|----------------------------------|---------------------------------------------------------------------------------------------------------|
| `test_create_schema`             | Cr√©ation & structure compl√®te des 4 sch√©mas JSON MongoDB                                                |
| `test_load_data_transformation`  | Typage (long/int/double), mise en casse, normalisation des valeurs                                      |
| `test_schema_rejects_invalid_doc`| Injection d‚Äôun document invalide ‚Üí rejet (simulateur mongomock)                                        |
| `test_batch_logging_and_processing`| V√©rifie que les logs indiquent correctement la progression par lots                                    |
| `test_malformed_csv_logs_error`  | Fichier CSV mal form√© ‚Üí d√©tection & log d‚Äôerreur                                                       |
| `test_partial_schema_doc`        | Insertion d‚Äôun doc avec champ surplus ‚Üí tol√©r√© (non bloquant)                                          |
| `test_gender_capitalization`     | ‚Äúmale‚Äù ‚Üí ‚ÄúMale‚Äù ; ‚ÄúFEMALE‚Äù ‚Üí ‚ÄúFemale‚Äù                                                                   |
| `test_date_parsing`              | Cha√Ænes ‚Üí `datetime` na√Øf (timezone locale ou UTC de la JVM mongomock)                                 |
| `test_data_integrity_against_schema`| Concordance colonnes CSV ‚ÜîÔ∏é champs Mongo, non-nullit√© des requis                                      |
| `test_no_null_fields_after_migration`| V√©rifie que les champs requis sont effectivement non null dans MongoDB                                |
| `test_csv_and_mongo_count_match` | Lignes ins√©r√©es == lignes valides du CSV                                                                |
| `test_empty_csv`                 | CSV vide ‚Üí warning loggu√©, aucune insertion                                                             |

---

## üì¶ Dockerisation

### `Dockerfile` (app)

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
ENTRYPOINT ["python", "healthcare_mongo_loader_optimized.py"]
```

### `docker-compose.yml`

```yaml
version: '3.9'

services:
  mongodb:
    image: mongo:8.0
    container_name: mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=rootpwd
      - MONGO_INITDB_DATABASE=HealthcareDB
    volumes:
      - mongo-data:/data/db
    networks:
      - healthcare-net

  app:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: healthcare_loader
    depends_on:
      - mongodb
    volumes:
      - csv-data:/app/data
    networks:
      - healthcare-net
    environment:
      - PYTHONUNBUFFERED=1
      # NO LONGER NEEDED HERE if hardcoding in command, but keeping for clarity
      # - MONGO_URI=mongodb://loader:loaderpwd@mongo:27017/HealthcareDB?authSource=HealthcareDB
      # - ADMIN_MONGO_URI=mongodb://root:rootpwd@mongo:27017/admin?authSource=admin
    command: >
      bash -c "
      sleep 15 &&
      python healthcare_mongo_loader_optimized.py \
      --csv /app/data/healthcare_dataset.csv \
      --mongo_uri 'mongodb://loader:loaderpwd@mongodb:27017/HealthcareDB?authSource=HealthcareDB' \
      --db_name HealthcareDB \
      --admin_mongo_uri 'mongodb://root:rootpwd@mongodb:27017/admin?authSource=admin'
      "

volumes:
  mongo-data:
  csv-data:

networks:
  healthcare-net:
    driver: bridge
```

---

## ‚öôÔ∏è Makefile

```makefile
build:          ## Build Docker images
	docker compose build

up:             ## Start stack (Mongo + App)
	docker compose up -d

logs:           ## Follow app logs
	docker compose logs -f app

down:           ## Stop & remove containers
	docker compose down

test:           ## Run pytest suite
	pytest -v test
```

---

## üîê Contr√¥le d‚Äôacc√®s / S√©curit√© (CE3)

### 1Ô∏è‚É£  Initialisation automatis√©e des r√¥les & utilisateurs MongoDB

1Ô∏è‚É£ Initialisation automatis√©e des r√¥les & utilisateurs

Le script healthcare_mongo_loader_optimized.py g√®re d√©sormais automatiquement la cr√©ation des r√¥les et des utilisateurs n√©cessaires lors de son premier lancement.

Cette initialisation est 

idempotente : si un r√¥le ou un utilisateur existe d√©j√†, sa cr√©ation est simplement ignor√©e, √©vitant ainsi les erreurs lors de lancements multiples.

| R√¥le Mongo / Utilisateur          | Privil√®ges pr√©cis sur `HealthcareDB`                                     | Pourquoi / p√©rim√®tre d‚Äôusage                                 |
|-----------------------------------|---------------------------------------------------------------------------|---------------------------------------------------------------|
| `loaderRole` (utilisateur **loader**)  | `find`, `insert`, `update`, `createIndex`, `collMod` sur *toutes* les collections | Pipeline d‚Äôingestion : ins√®re des documents, g√®re les index & validation JSON |
| `analystRole` (utilisateur **analyst**) | `find` (lecture seule) sur *toutes* les collections                       | BI, dashboards, consultation des donn√©es                      |
| *(r√¥le natif)* **admin** (utilisateur **admin**) | `dbAdmin` + `userAdmin`                                                   | Gestion des sch√©mas, index, utilisateurs & r√¥les              |

---

> 2Ô∏è‚É£  Authentification & Connexion de l‚Äôapplication

Le script utilise maintenant deux URIs de connexion distinctes, pass√©es en arguments, pour s√©parer les t√¢ches :

1. URI Admin (--admin_mongo_uri) : Utilis√©e une seule fois au d√©marrage pour se connecter en tant que root et ex√©cuter la cr√©ation des r√¥les/utilisateurs.

	- Exemple : mongodb://root:rootpwd@mongo:27017/admin

2. URI Loader (--mongo_uri) : Utilis√©e pour toutes les op√©rations de chargement de donn√©es avec l'utilisateur aux droits restreints loader.

	- Exemple : mongodb://loader:loaderpwd@mongo:27017/HealthcareDB?authSource=HealthcareDB

Ce d√©couplage est une bonne pratique de s√©curit√© qui garantit que l'application n'utilise les pleins pouvoirs que lorsque c'est strictement n√©cessaire.

---

### 3Ô∏è‚É£  S√©curit√© des mots de passe & recommandations 

‚úÖ **Stockage s√©curis√© dans MongoDB**  
> MongoDB utilise par d√©faut **SCRAM-SHA-256** pour le stockage des mots de passe.  
> Il s‚Äôagit d‚Äôun protocole d‚Äôauthentification s√©curis√© avec challenge-r√©ponse et salage du hash, respectant les bonnes pratiques OWASP.

‚úÖ **Pas de stockage en clair** dans les bases ‚Äî ni dans le code.

---

### 4Ô∏è‚É£  Bonnes pratiques suppl√©mentaires recommand√©es

| Mesure                                  | Impl√©mentation actuelle / Recommandation |
|-----------------------------------------|------------------------------------------|
| **Transport s√©curis√© (TLS)**            | Ajouter `--tlsMode requireTLS` + certificats sign√©s |
| **Secrets prot√©g√©s**                    | G√©rer les mots de passe via [Docker Secrets](https://docs.docker.com/engine/swarm/secrets/), fichiers `.env` non commit√©s ou Hashicorp Vault |
| **Chiffrement des donn√©es au repos**    | Possible avec le moteur de stockage chiffr√© (MongoDB Enterprise) |
| **Sauvegardes r√©guli√®res**              | Ex : `mongodump` via cronjob ou automatisation cloud |
| **Audit des acc√®s**                     | Activer l‚Äô`auditLog` (si besoin de tra√ßabilit√© fine) |

---

### 5Ô∏è‚É£  Exemple de fichier `.env` (recommand√©)

```
MONGO_INITDB_ROOT_USERNAME=root
MONGO_INITDB_ROOT_PASSWORD=rootpwd
LOADER_USER=loader
LOADER_PASS=loaderpwd
```

> Ces variables peuvent ensuite √™tre inject√©es dans le `docker-compose.yml` ou via pipeline CI/CD.

---

‚úÖ **Cette politique d‚Äôacc√®s respecte le principe du moindre privil√®ge**  
> Chaque utilisateur Mongo a **uniquement** les droits n√©cessaires √† son r√¥le m√©tier.


## ‚ñ∂Ô∏è Lancer la migration compl√®te

```bash
make build      # construit les images
make up         # d√©marre Mongo + loader (la migration s‚Äôex√©cute une fois)
make logs       # suit le stdout de l‚Äôapp
```

Arr√™t & nettoyage :

```bash
make down
docker volume prune -f   # ‚ö†Ô∏è  supprime les donn√©es Mongo
```

---

## üë®‚Äçüíª Auteur

Rudy Desplan ‚Äì Data Engineer