Below is the **complete, up-to-date `README.md`** with an expanded **üîê Contr√¥le d‚Äôacc√®s / S√©curit√© (CE3)** section that shows *exact* Mongo Shell / `mongosh` commands to cr√©er les utilisateurs, attribuer les r√¥les et se connecter depuis le conteneur `app`.

````markdown
# üè• Healthcare CSV ‚Üí MongoDB Loader (v2)

Ce projet fournit un pipeline **robuste, test√©, dockeris√© et extensible** pour charger des donn√©es patients depuis un CSV vers MongoDB.

Il suit un **d√©veloppement par branches** avec revue des fonctionnalit√©s avant merge.

- **main** ‚Äî branche de production
- **dev** ‚Äî branche de d√©veloppement continu
- **remote-testing** ‚Äî branche d√©di√©e aux tests d'int√©gration √† distance

üìÖ **Historique de commits actif sur ‚â• 2 semaines**  
üí¨ Visualisez le graphe r√©seau complet ici :  
[https://github.com/rudydesplan/Projet5_OC_DE/network](https://github.com/rudydesplan/Projet5_OC_DE/network)

![GitHub Network Graph](https://github.com/rudydesplan/Projet5_OC_DE/raw/main/docs/github-network.png)

---

> üí° *L'image ci-dessus est g√©n√©r√©e depuis l'onglet **Insights ‚Üí Network** de GitHub.*  
> Elle prouve l‚Äôusage actif de branches, de merges et de commits continus.
---

## üöÄ Fonctionnalit√©s cl√©s

| ‚úî  | D√©tail |
|----|--------|
|üóÑÔ∏è|**Sch√©mas JSON** stricts sur 4 collections (Patients, Admissions, MedicalRecords, Billing)|
|‚ö°|Insertion **batch** via `bulk_write` (mode *ordonn√©* ‚áí arr√™t sur premi√®re erreur, reprise automatique)|
|üîç|**Index** compos√©s et simples cr√©√©s automatiquement|
|üßΩ|Nettoyage & validation **vectoris√©s** (`pandas`) avant insertion|
|üìù|**Logs** d√©taill√©s (rotation 500 KB / 5 jours) via `loguru`|
|üß™|Tests **unitaires** isol√©s (`pytest` + `mongomock`)|
|üê≥|D√©ploiement **Docker / Docker-Compose** (Mongo + App)|
|üõ†|Commandes **Makefile** ‚Äúbuild / up / down / test‚Äù|
|üîê|Section S√©curit√© : **auth Mongo, r√¥les, commandes de cr√©ation, connexion**|

---

## üóÇ Arborescence du projet

```bash
project-root/
‚îú‚îÄ‚îÄ Makefile                    ‚Üê Commandes rapides
‚îú‚îÄ‚îÄ docker-compose.yml          ‚Üê Orchestration Mongo + App
‚îú‚îÄ‚îÄ README.md                   ‚Üê Ce fichier
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile              ‚Üê Image de l'application
‚îÇ   ‚îú‚îÄ‚îÄ healthcare_mongo_loader_optimized.py
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ   ‚îî‚îÄ‚îÄ data/
‚îÇ       ‚îî‚îÄ‚îÄ healthcare_dataset.csv
‚îî‚îÄ‚îÄ test/
    ‚îî‚îÄ‚îÄ test_healthcare_loader.py
```

---

## üß© Sch√©mas JSON appliqu√©s / mis √† jour  

| Collection         | Champs (cl√©s)                                                       | Contraintes principales*                                                                                                      |
|--------------------|---------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------|
| **Patients**       | `Name`, `Age`, `Gender`, `Blood Type`, `Medical Condition`          | `Name : string` ¬∑ `Age : long ‚àà [0-125]` ¬∑ `Gender ‚àà {Male, Female}` ¬∑ `Blood Type ‚àà {A¬±, B¬±, O¬±, AB¬±}` ¬∑ `Medical Condition ‚àà {Cancer, Obesity, Diabetes, Asthma, Hypertension, Arthritis}` |
| **Admissions**     | `patient_id`, `Date of Admission`, `Admission Type`, `Room Number`, `Discharge Date` | `patient_id : objectId` ¬∑ `Date of Admission : date` ¬∑ `Admission Type ‚àà {Urgent, Emergency, Elective, null}` ¬∑ `Room Number : long ‚â• 1 | null` ¬∑ `Discharge Date : date | null` |
| **MedicalRecords** | `patient_id`, `Doctor`, `Hospital`, `Medication`, `Test Results`    | `patient_id : objectId` ¬∑ `Doctor : string` ¬∑ `Hospital : string` ¬∑ `Medication : string | null` ¬∑ `Test Results ‚àà {Normal, Abnormal, Inconclusive, null}` |
| **Billing**        | `patient_id`, `Billing Amount`, `Insurance Provider`                | `patient_id : objectId` ¬∑ `Billing Amount : double ‚â• 0 | null` ¬∑ `Insurance Provider : string | null`                                                              |

\*Table simplifi√©e ; les d√©finitions compl√®tes (titres, types BSON, `required`, bornes, etc.) se trouvent dans `healthcare_mongo_loader_optimized.py`.

> Les sch√©mas sont appliqu√©s via `collMod` (si la collection existe) ou lors de la cr√©ation (`validationLevel: "strict"`, `validationAction: "error"`).

---

üìä **Diagramme entit√©-relation des collections**

![MongoDB Schema Diagram](https://github.com/rudydesplan/Projet5_OC_DE/raw/main/docs/diagram.png)

*Ce diagramme montre les relations entre la collection centrale `Patients` et les collections secondaires li√©es (`Admissions`, `MedicalRecords`, `Billing`).*

## ‚ö° Index cr√©√©s automatiquement

| Collection     | Index                                         | Pourquoi un ¬´ 1 ¬ª ?*                                  |
| -------------- | --------------------------------------------- | ----------------------------------------------------- |
| Patients       | `[(Name,1)‚Ä¶(Medical Condition,1)]` **unique** | `1` = *ordre croissant* (cl√© d‚Äôindex Mongo classique) |
| Admissions     | `[(patient_id,1),(Date of Admission,1)]`      | Acc√®s rapide par patient + p√©riode                    |
| MedicalRecords | `[(patient_id,1),(Doctor,1)]`                 | Requ√™tes patient-m√©decin                              |
| Billing        | `[(patient_id,1),(Billing Amount,1)]`         | Analyse facturation par patient                       |

\*Dans MongoDB un index se d√©finit par (cl√©, direction) ; `1` = ASC, `-1` = DESC.

---

## üß≠ Flux de traitement

1. **Lecture** CSV en chunks (taille par d√©faut 5 000).
2. **Conversions num√©riques** (`Age`, `Room Number` ‚Üí `Int64`; `Billing Amount` ‚Üí `float64`).
3. **Nettoyage texte** (trim, upper/lower/title, NULL-likes).
4. **Validation vectoris√©e** (`validate_patients`) ‚Üí masque True/False.
5. **Bulk-upsert** Patients (`ordered=True` : arr√™t sur erreur, rejoue le reste unitaire).
6. **R√©cup√©ration des `_id`** nouvellement cr√©√©s.
7. **Pr√©paration** & **bulk-insert** *ordonn√©s* des documents li√©s (Admissions / Medical / Billing).
8. `bypass_document_validation=False` : Mongo **revalide** chaque insert.
9. **Logs** succ√®s / erreurs chunk par chunk.

---

## ‚úÖ Tests automatis√©s (`pytest + mongomock`)

```bash
make test
```

Le jeu de tests v√©rifie :

| Test                              | Description                                                                                             |
|----------------------------------|---------------------------------------------------------------------------------------------------------|
| `test_create_schema`             | Cr√©ation & structure compl√®te des 4 sch√©mas JSON MongoDB                                                |
| `test_load_data_transformation`  | Typage (long/int/double), mise en casse, normalisation des valeurs                                      |
| `test_schema_rejects_invalid_doc`| Injection d‚Äôun document invalide ‚Üí rejet (simulateur mongomock)                                        |
| `test_batch_logging_and_processing`| V√©rifie que les logs indiquent correctement la progression par lots                                    |
| `test_malformed_csv_logs_error`  | Fichier CSV mal form√© ‚Üí d√©tection & log d‚Äôerreur                                                       |
| `test_partial_schema_doc`        | Insertion d‚Äôun doc avec champ surplus ‚Üí tol√©r√© (non bloquant)                                          |
| `test_gender_capitalization`     | ‚Äúmale‚Äù ‚Üí ‚ÄúMale‚Äù ; ‚ÄúFEMALE‚Äù ‚Üí ‚ÄúFemale‚Äù                                                                   |
| `test_date_parsing`              | Cha√Ænes ‚Üí `datetime` na√Øf (timezone locale ou UTC de la JVM mongomock)                                 |
| `test_data_integrity_against_schema`| Concordance colonnes CSV ‚ÜîÔ∏é champs Mongo, non-nullit√© des requis                                      |
| `test_no_null_fields_after_migration`| V√©rifie que les champs requis sont effectivement non null dans MongoDB                                |
| `test_csv_and_mongo_count_match` | Lignes ins√©r√©es == lignes valides du CSV                                                                |
| `test_empty_csv`                 | CSV vide ‚Üí warning loggu√©, aucune insertion                                                             |

---

## üì¶ Dockerisation

### `Dockerfile` (app)

```dockerfile
FROM python:3.11-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
ENTRYPOINT ["python", "healthcare_mongo_loader_optimized.py"]
```

### `docker-compose.yml`

```yaml
version: "3.8"

services:
  mongo:
    image: mongo:6
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      # Active l'auth d√®s le 1er lancement
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=rootpwd
    volumes:
      - mongo_data:/data/db

  app:
    build: ./app
    depends_on: [mongo]
    environment:
      - MONGO_URI=mongodb://loader:loaderpwd@mongo:27017/HealthcareDB?authSource=HealthcareDB
    volumes:
      - ./app/data:/app/data
    command: >
      python healthcare_mongo_loader_optimized.py
      --csv /app/data/healthcare_dataset.csv
      --mongo_uri ${MONGO_URI}

volumes:
  mongo_data:
```

---

## ‚öôÔ∏è Makefile

```makefile
build:          ## Build Docker images
	docker compose build

up:             ## Start stack (Mongo + App)
	docker compose up -d

logs:           ## Follow app logs
	docker compose logs -f app

down:           ## Stop & remove containers
	docker compose down

test:           ## Run pytest suite
	pytest -v test
```

---

## üîê Contr√¥le d‚Äôacc√®s / S√©curit√© (CE3)

### 1Ô∏è‚É£  Cr√©ation des r√¥les & utilisateurs MongoDB

| R√¥le Mongo / Utilisateur | Privil√®ges pr√©cis sur `HealthcareDB` | Pourquoi / p√©rim√®tre d‚Äôusage | Commande `mongosh` de cr√©ation* |
|--------------------------|--------------------------------------|------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `loaderRole` (utilisateur **loader**) | `insert`, `update`, `createIndex`, `collMod` sur *toutes* les collections | Pipeline d‚Äôingestion : ins√®re des documents, g√®re les index & validation JSON | ```js\nuse HealthcareDB\ndb.createRole({ role: "loaderRole", privileges: [{ resource: { db: "HealthcareDB", collection: "" }, actions: ["insert","update","createIndex","collMod"] }], roles: [] })\ndb.createUser({ user: "loader", pwd: "loaderpwd", roles: ["loaderRole"] })``` |
| `analystRole` (utilisateur **analyst**) | `find` (lecture seule) sur *toutes* les collections | BI, dashboards, consultation des donn√©es | ```js\nuse HealthcareDB\ndb.createRole({ role: "analystRole", privileges: [{ resource: { db: "HealthcareDB", collection: "" }, actions: ["find"] }], roles: [] })\ndb.createUser({ user: "analyst", pwd: "analystpwd", roles: ["analystRole"] })``` |
| *(r√¥le natif)* **admin** (utilisateur **admin**) | `dbAdmin` + `userAdmin` | Gestion des sch√©mas, index, utilisateurs & r√¥les | ```js\nuse HealthcareDB\ndb.createUser({ user: "admin", pwd: "adminpwd", roles: [ { role: "dbAdmin", db: "HealthcareDB" }, { role: "userAdmin", db: "HealthcareDB" } ] })``` |

---

> Connectez-vous avec `mongosh` pour ex√©cuter les commandes de cr√©ation :
```bash
docker compose exec mongo mongosh -u root -p rootpwd --authenticationDatabase admin
```

**Extraits de commandes MongoDB**  
```javascript
use HealthcareDB

// R√¥le loader
db.createRole({
  role: "loaderRole",
  privileges: [{ resource: { db: "HealthcareDB", collection: "" }, actions: ["insert", "update", "createIndex", "collMod"] }],
  roles: []
})

// R√¥le analyst
db.createRole({
  role: "analystRole",
  privileges: [{ resource: { db: "HealthcareDB", collection: "" }, actions: ["find"] }],
  roles: []
})

// Utilisateurs
db.createUser({ user: "loader", pwd: "loaderpwd", roles: ["loaderRole"] })
db.createUser({ user: "analyst", pwd: "analystpwd", roles: ["analystRole"] })
db.createUser({
  user: "admin",
  pwd: "adminpwd",
  roles: [
    { role: "dbAdmin", db: "HealthcareDB" },
    { role: "userAdmin", db: "HealthcareDB" }
  ]
})
```

---

### 2Ô∏è‚É£  Authentification & Connexion de l‚Äôapplication

Le conteneur Python utilise l‚ÄôURI suivante pour se connecter √† MongoDB :  
```
mongodb://loader:loaderpwd@mongo:27017/HealthcareDB?authSource=HealthcareDB
```

Cette URI est fournie via la variable d‚Äôenvironnement `MONGO_URI` du `docker-compose.yml` et transmise au script via l‚Äôargument `--mongo_uri`.

---

### 3Ô∏è‚É£  S√©curit√© des mots de passe & recommandations 

‚úÖ **Stockage s√©curis√© dans MongoDB**  
> MongoDB utilise par d√©faut **SCRAM-SHA-256** pour le stockage des mots de passe.  
> Il s‚Äôagit d‚Äôun protocole d‚Äôauthentification s√©curis√© avec challenge-r√©ponse et salage du hash, respectant les bonnes pratiques OWASP.

‚úÖ **Pas de stockage en clair** dans les bases ‚Äî ni dans le code.

---

### 4Ô∏è‚É£  Bonnes pratiques suppl√©mentaires recommand√©es

| Mesure                                  | Impl√©mentation actuelle / Recommandation |
|-----------------------------------------|------------------------------------------|
| **Transport s√©curis√© (TLS)**            | Ajouter `--tlsMode requireTLS` + certificats sign√©s |
| **Secrets prot√©g√©s**                    | G√©rer les mots de passe via [Docker Secrets](https://docs.docker.com/engine/swarm/secrets/), fichiers `.env` non commit√©s ou Hashicorp Vault |
| **Chiffrement des donn√©es au repos**    | Possible avec le moteur de stockage chiffr√© (MongoDB Enterprise) |
| **Sauvegardes r√©guli√®res**              | Ex : `mongodump` via cronjob ou automatisation cloud |
| **Audit des acc√®s**                     | Activer l‚Äô`auditLog` (si besoin de tra√ßabilit√© fine) |

---

### 5Ô∏è‚É£  Exemple de fichier `.env` (recommand√©)

```
MONGO_INITDB_ROOT_USERNAME=root
MONGO_INITDB_ROOT_PASSWORD=rootpwd
LOADER_USER=loader
LOADER_PASS=loaderpwd
```

> Ces variables peuvent ensuite √™tre inject√©es dans le `docker-compose.yml` ou via pipeline CI/CD.

---

‚úÖ **Cette politique d‚Äôacc√®s respecte le principe du moindre privil√®ge**  
> Chaque utilisateur Mongo a **uniquement** les droits n√©cessaires √† son r√¥le m√©tier.


## ‚ñ∂Ô∏è Lancer la migration compl√®te

```bash
make build      # construit les images
make up         # d√©marre Mongo + loader (la migration s‚Äôex√©cute une fois)
make logs       # suit le stdout de l‚Äôapp
```

Arr√™t & nettoyage :

```bash
make down
docker volume prune -f   # ‚ö†Ô∏è  supprime les donn√©es Mongo
```

---

## üë®‚Äçüíª Auteur

Rudy Desplan ‚Äì Data Engineer
````
